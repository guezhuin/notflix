#!/bin/sh
# .githooks/pre-commit

echo "ğŸ” Running pre-commit checks..."

# Check that we're in a virtual environment
if [ -z "$VIRTUAL_ENV" ]; then
    echo "âš ï¸  Warning: Virtual environment not detected. Consider activating it."
fi

# Change to the backend directory
cd backend || exit 1

# Check for required files
if [ ! -f "requirements/dev.txt" ]; then
    echo "âŒ requirements/dev.txt not found"
    exit 1
fi

# Install dependencies if necessary
if [ ! -d ".venv" ] && [ -z "$VIRTUAL_ENV" ]; then
    echo "ğŸ“¦ Installing dependencies..."
    pip install -r requirements/dev.txt > /dev/null 2>&1
fi

# # 1. Check code format with Ruff
# echo "ğŸ¨ Checking code format..."
# if ! ruff format --check . --quiet; then
#     echo "âŒ Code format check failed. Run 'ruff format .' to fix."
#     exit 1
# fi

# # 2. Check linting with Ruff
# echo "ğŸ” Running linter..."
# if ! ruff check . --quiet; then
#     echo "âŒ Linting failed. Run 'ruff check . --fix' to fix auto-fixable issues."
#     exit 1
# fi

# 3. Check security vulnerabilities
echo "ğŸ›¡ï¸  Checking security vulnerabilities..."
if ! pip-audit -r requirements/base.txt > /dev/null 2>&1; then
    echo "âŒ Security vulnerabilities found!"
    exit 1
fi

# 4. Check Django migrations
echo "ğŸ—„ï¸  Checking Django migrations..."
cd app || exit 1
if ! python manage.py makemigrations --check --dry-run --settings=config.settings.dev > /dev/null 2>&1; then
    echo "âŒ Missing migrations detected. Run 'python manage.py makemigrations'."
    exit 1
fi

# 5. Check Django configuration
echo "âš™ï¸  Checking Django configuration..."
if ! python manage.py check --settings=config.settings.dev > /dev/null 2>&1; then
    echo "âŒ Django configuration check failed."
    exit 1
fi

# 6. Run quick tests
echo "ğŸ§ª Running quick tests..."
if [ -d "tests" ] || find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
    if ! python -m pytest -x --quiet --tb=no -m "not slow" > /dev/null 2>&1; then
        echo "âŒ Quick tests failed. Run 'pytest' for details."
        exit 1
    fi
else
    echo "â„¹ï¸  No tests found, skipping test execution."
fi

echo "âœ… All pre-commit checks passed!"
exit 0
