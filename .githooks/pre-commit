#!/bin/sh
# .githooks/pre-commit

echo "🔍 Running pre-commit checks..."

# Check that we're in a virtual environment
if [ -z "$VIRTUAL_ENV" ]; then
    echo "⚠️  Warning: Virtual environment not detected. Consider activating it."
fi

# Change to the backend directory
cd backend || exit 1

# Check for required files
if [ ! -f "requirements/dev.txt" ]; then
    echo "❌ requirements/dev.txt not found"
    exit 1
fi

# Install dependencies if necessary
if [ ! -d ".venv" ] && [ -z "$VIRTUAL_ENV" ]; then
    echo "📦 Installing dependencies..."
    pip install -r requirements/dev.txt > /dev/null 2>&1
fi

# # 1. Check code format with Ruff
# echo "🎨 Checking code format..."
# if ! ruff format --check . --quiet; then
#     echo "❌ Code format check failed. Run 'ruff format .' to fix."
#     exit 1
# fi

# # 2. Check linting with Ruff
# echo "🔍 Running linter..."
# if ! ruff check . --quiet; then
#     echo "❌ Linting failed. Run 'ruff check . --fix' to fix auto-fixable issues."
#     exit 1
# fi

# 3. Check security vulnerabilities
echo "🛡️  Checking security vulnerabilities..."
if ! pip-audit -r requirements/base.txt > /dev/null 2>&1; then
    echo "❌ Security vulnerabilities found!"
    exit 1
fi

# 4. Check Django migrations
echo "🗄️  Checking Django migrations..."
cd app || exit 1
if ! python manage.py makemigrations --check --dry-run --settings=config.settings.dev > /dev/null 2>&1; then
    echo "❌ Missing migrations detected. Run 'python manage.py makemigrations'."
    exit 1
fi

# 5. Check Django configuration
echo "⚙️  Checking Django configuration..."
if ! python manage.py check --settings=config.settings.dev > /dev/null 2>&1; then
    echo "❌ Django configuration check failed."
    exit 1
fi

# 6. Run quick tests
echo "🧪 Running quick tests..."
if [ -d "tests" ] || find . -name "test_*.py" -o -name "*_test.py" | grep -q .; then
    if ! python -m pytest -x --quiet --tb=no -m "not slow" > /dev/null 2>&1; then
        echo "❌ Quick tests failed. Run 'pytest' for details."
        exit 1
    fi
else
    echo "ℹ️  No tests found, skipping test execution."
fi

echo "✅ All pre-commit checks passed!"
exit 0
